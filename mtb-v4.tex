Našim základním cílem v této kapitole bude navrhnout \gls{plc} systém, který
splňuje požadavky definované na konci kapitoly \ref{chap:nasazeni}. Při návrhu
tohoto systému vyjdeme z přirozeného požadavku na minimální změny v aktuálním
harwaru a softwaru kolejiště. Navrhneme nový systém jako iteraci současného
systému \gls{mtb}. Tento systém pojmenujeme \textit{MTB v4}.

Nový systém vyřeší všechny problémy aktuální verze systému \gls{mtb} popsané
v kapitole \ref{chap:nasazeni}. Při návrhu vezmeme v potaz aktuální technologie
v oblasti \gls{plc} obvodů a zvážíme implementace těcht technolgií. Detailně
rozebereme současnou implementace protokolu \gls{mtbbus} a u každé položky
zvolíme, jestli a proč ji chceme zachovat.

\section{Podrobná specifikace požadavků}

Abychom byli schopni navrhnout MTB v4, musíme znát přesné požadavky na takový
systém. Nyní požadavky formulujeme, přičemž budeme klást důraz na vysvětlení
změn oproti současnému systému \gls{mtb}.

Zaměřme se nejprve po požadavky, které na systém \gls{mtb} kladou komponenty,
které tento systém používají.

\subsection{Periferie v kolejišti}

K \gls{mtb} se na straně kolejiště připojují jednotlivé vstupy a výstupy
popsané v kapitole \ref{chap:existujici-reseni}. Všechny v současnosti na
kolejišti používané vstupy jsou digitálního formátu (binární vstupy), výstupy
jsou buď digitální binární nebo S-COM \ref{scom}. S-COM výstupy jsou ve
skutečnosti digitální výstupy, do kterých MTB deska moduluje S-COM signál.
S-COM signál je jednoduchý pomalý signál, který lze s přehledem vytvářet běžným
výstupním pinem procesoru nebo posuvného registru.

Oproti současnému \gls{mtb} bychom nově chtěli podporovat \textit{kmitavý
výstup} s počítačově definovou frekvencí kmitání a pevnou střídou. Jednalo by
se o kmitání v řádu jednotek \textit{Hz}, využití tohoto typu výstupu je pro
indikace v pultech a rozpojovače \ref{rozp}. I toto je však z pohledu hardwaru
jednoduchý digitální výstup, pro přidání tohoto typu výstupu je třeba upravit
pouze komunikační protokol a software a firmware modulů.

Současné moduly \textit{MTB-UNI} umožňují výstupy typu S-COM pouze na pinech
0–7, což je omezení dané malou pamětí procesoru. Toto omezení by mělo
\textit{MTB v4} relaxovat a umožnit tak, aby každý výstup mohl být v jednom
z režimů

\begin{compactenum}
\item digitální,
\item S-COM,
\item kmitavý.
\end{compactenum}

Co se týče vstupně-výstupních požadavků, \textit{MTB v4} by si vystačilo pouze
s moduly typu \textit{MTB-UNI} \ref{uni}. Na kolejišti v současnosti není žádný
prvek, který by vyžadoval například analogový vstup, analogový výstup nebo např.
\textit{PWM} výstup. Na kolejištích se hojně používají servomotory, ale vždy
pro řízení dvoupolohových prvků: výhybka, výkolejka, mechanické návěstidlo.
Všechny tyto prvky k sobě mají řídicí elektroniku, která interaguje se systémem
\gls{mtb} pouze digitálními piny. Typicky stačí 2 digitální výstupy (pro
nastavení požadované polohy) a případně 2 digitální vstupy (pro detekci koncové
polohy).

Zmiňme na tomto místě, že neimplementace PWM výstupů do \textit{MTB-UNI v4}
desky je koncepčním rozhodnutím autora této práce. Autor práce razí přístup
\uv{ať jedna věc dělá jeden úkol a dělá ho dobře}. Místo návrhu všemocného
\textit{MTB-UNI} modulu, který za pár let bude umět i uvařit kávu, se autor
rozhodl vydat cestou univerzálního kompaktního snadno sériově vyrobitelného
modulu s prostými digitálními vstupy a výstupy.

Připomeňme, že \textit{MTB-UNI} desky umožňují speciální typ vstupů – IR vstupy,
viz sekci \ref{sec:uni_ir}. Tyto vstupy vyžadují další elektroniku navíc.
V nových \textit{MTB-UNI v4} deskách bude podpora pro IR čidla zrušena ve jménu
předchozího odstavce. Bude navržena speciální deska pro buzení a vyhodnocování
stavu IR čidel, která se bude připojovat přímo k digitálním vstupům
\textit{MTB-UNI} desky. Ušetří se tak elektronika na \textit{MTB-UNI} deskách,
na kterých se IR vstupy nevyužívají, zjednoduší se návrh desky plošných spojů
a umožní se využít IR čidla i s jinými deskami, než MTB, např. pro přímou
indikaci v pultech. Jedna deska bude dělat jednu věc a bude ji dělat dobře.

Na současném kolejišti si tedy vystačím pouze s \textit{MTB-UNI} deskami, které
budou navíc ořezané o podporu IR čidel. Ačkoliv je toto tvrzení pravdivé, bylo
by neperspektivní si podporu jiných typů desek zavřít volbou nevhodného
protokolu. Nový protokol sběrnice \gls{mtbbus} by měl být navržený univerzálně
pro nejrůznější možné typu desek, které v budoucnu mohou přijít. Autor této
práce má již v záměru takové desky desky vytvořit, více se můžete dočíst
v budoucí kapitole \ref{todo}.

\subsection{Ovládání}

Dalším uživatelem systému \gls{mtb} je řídicí software kolejiště. Tento
software je aktuálně na programován pro operační systém Windows a s hardwarem
kolejiště komunikuje pomocí dynamicky linkované knihovny, která musí dodržet
specifikované API \cite{api}. Na straně softwaru máme tedy relativně volné
ruce.

Princip řízení kolejiště dává požadavek na organizaci \gls{mtbbus} v4 sběrnice:
jednotlivé prvky jsou řízeny počítačem a výhradně počítačem.

Novým požadavkem je, aby v počítači mohlo existovat více softwarů, které
sběrnici řídí. V praxi totiž nastává kdy na jednu sběrnici jsou připojené systémy,
které mají být z principu řízeny různými programy: například zabezpečení řízení
provozu kolejiště a řízení pouličního a domovního osvětlení. Je vhodné mít oba
systémy zapojené do jedné sběrnice, aby se minimalizoval počet modulů, zejména
proto, že výstupů na řízení osvětlení je oproti řízení zabezpečení provozu málo.
Dává však také smysl, aby software pro řízení provozu neřídil osvětlení, protože
to není jeho účel.

Dalším reálným příkladem z \gls{kmz} je jedna sběrnice, na které jsou připojeny
periferie řízení tramvajové dopravy zároveň s periferiemi řízení silniční
dopravy. Přestože oba systémy sdíli společnou sběrnici, na úrovni počítače by
tyto systémy měly řídit dva různé programy. Jednom z hlavních přidaných hodnot
návrhu nového systému MTB je, že umožní \textit{multi-mater} řízení.

\subsection{Další požadavky}

Uveďme nyní některé méně důležité požadavky na novou verzi sběrnici \gls{mtbbus},
jejichž naplnění nám však výrazně zpříjemní její používání. Již teď předejímáme,
že všechny tyto požadavky se v implementaci podařilo naplnit.

\begin{enumerate}
\item \textbf{Umožnit nalezení \gls{mtb} modulů i po startu sběrnice.}

	V kapitole \ref{sec:mtbbus} byl popsán poměrně striktní proces používání
	sběrnice – od vyhledání modulů až po ukončení práce se sběrnicí. Současná
	implementace tohoto procesu neumožňuje, aby počítač detekoval moduly, které
	na sběrnici přibudou za jejího chodu. Taková situace může nastat například
	tak, že je prvně zapnut řídicí počítač a až pak napájení sběrnice. Je
	nepříjemné muset v takovém případě manuálně spouštět proces skenování
	znovu.

	Obecně se celý postup práce se sběrnicí popsaný v kapitole \ref{sec:mtbbus}
	zdá být příliš striktním. \gls{mtb} v4 by mělo tento proces zjednodušit.

\item \textbf{Z počítače bude možné na každém modulu zapnout identifikační LED.}

	Pro snadnou identifikaci konkrétního modulu v kolejišti, například při
	diagnostice závady, by operátor měl mít možnost na libovolném modulu
	zapnout indikační LED. Při diagnostice pod kolejištěm tak snadno identifikuje
	konkrétní modul.

\item \textbf{Firmware \gls{mtb} modulů by mělo být možné aktualizovat přímo
	po sběrnici \gls{mtbbus}.}

	Pod kolejištěm jsou nasazeny vyšší desítky modulů. Aktualizace jejich
	firmwaru ručním programováním všech modulů by byla časově náročná. Sběrnice
	by měla umožňovat aktualizaci firmwaru modulů přímo, ideálně za současného
	plného chodu zbytku modulů.

\end{enumerate}

\subsection{Shrnutí požadavků}

Shrňme stručně všechny požadavky na systém \gls{mtb} v4.

\begin{compactenum}
\item K \gls{mtb} v4 se musí na straně počítače dát přistoupit skrze hJOP RCS
	API \cite{}.
\item V počítači může běžet více softwarů řídících výstupy a snímajících vstupy
	modulů sběrnice \gls{mtbbus} v4.
\item Systém \gls{mtb} v4 musí být navržený univerzálně pro nejrůznější typy
	modulů. Jedinou společnou vlastností modulů je, že snímají vstupy a nastavují
	výstupy.
\item Je třeba vyřešit zpětnou kompatibilitu především se stávajícími
	\textit{MTB-UNI} deskami v kolejišti.
\item Celé řešení by mělo být psáno opensource a openhardware, aby se dalo volně
	využívat.
\item Desky sběrnice \gls{mtbbus} v4 by mělo být možné průběžně vyhledávat,
	a detekovat nefunkční.
\item Implementace systému by měla využívat osvědčené komponenty, u nichž
	je dlouhodobý výhled dostupnosti.
\item Desky \gls{mtb} potvrzují příkazy, lze monitorovat jejich správnou funkčnost.
\item Z počítače bude možné na každém modulu zapnout identifikační LED.
\item Moduly \textit{MTB-UNI} budou nově podporovat kmitavé výstupy.
\item Moduly \textit{MTB-UNI} budou nově podporovat S-COM výstupy na všech pinech.
\end{compactenum}


\section{Návrh systému MTB v4}

Nyní provedeme návrh nového systému pro sběr dat z kolejiště a ovládání
periferií kolejiště. Detailně zdůvodníme každý aspekt nově navrhnutého systému.

\subsection{Vysokoúrovňový návrh}

Zachováme základní koncept fungování systému \gls{mtb} \uv{single master,
multiple slaves}. Vytvoříme novou verzi modulu \textit{MTB-USB}, který bude
jako jediný řídicím prvkem nové sběrnice \gls{mtbbus} v4. Model \textit{single
master, multiple slaves} je osvědčeným modelem, který se snadno implementuje,
lze snadno spočítat nejlepší a nejhorší časy odezvy sběrnice a obecně se dobře
mapuje na problém, který systémem \gls{mtb} chceme řešit.

Vytvořením nové verze modulu \textit{MTB-USB} sledujeme především to, aby
existovala svobodná implementace této desky, nová deska nám dále umožní využívat
moderních procesorů a integrovaných obvodů, které nám usnadní implementaci.
Tuto desku si můžeme dovolit vytvořit úplně novou, protože je pouze jedna
pro celé kolejiště. Malé počty desek implikují malé náklady na aktualizaci
sběrnice, což je přesně to, co chceme.

Navrhneme novou \textit{MTB-USB} desku, která bude splňovat všechny požadavky
definované výše a která bude založena na moderních, ale dlouhodobě dostupných
součástkách.

Nebudeme však vynucovat výměnu všech stávajících \textit{MTB-UNI} desek v
kolejišti. Provedeme výměnu procesoru v současné \textit{MTB-UNI} desce za
procesor nový a umožníme tak starým deskám fungovat na nové sběrnici. Tím se
minimalizují náklady na povýšení sběrnice.

Navrhneme IR desku, která bude zajišťovat podporu IR čidel, protože nová
\textit{MTB-UNI} deska již nebude obsahovat přímou podporu IR čidel.

Zachování většiny stávajícího hardwaru současných \textit{MTB-UNI} s sebou nese
ponechání volby sběrnice \gls{mtbbus} na sběrnici RS485. RS485 nepřináší žádné
zjevné nevýhody, takže není důvod, proč hardwarovou vrstvu komunikační sběrnice
měnit.

\gls{mtb} moduly budou skrze desku \textit{MTB-USB} komunikovat s počítačem
po portu USB, kterým bude tunelován \textit{USB CDC} protokol. V počítači tak
bude celá sběrnice přístupná skrze sériový port. Počítač nemůže komunikovat
po sběrnici RS485 přímo, protože na to nemá hardwarové periferie, proto bude
komunikovat s modulem \textit{MTB-USB}, který bude řešit časově kritické operace
sběrnice \gls{mtbbus}. \footnote{TODO popsat?}

Otázkou zůstává, kde naplníme požadavek na \textit{multi-master} řízení celého
systému. Existují v zásadě 2 možné přístupy:

\begin{compactenum}
\item \textit{MTB-USB} deska se bude k počítači připojovat rozhraním, které
	nativně umožňuje komunikaci pouze s jednou aplikací (např. USB) a řízení více
	programy se bude řešit na úrovni softwaru v počítači.
\item \textit{MTB-USB} deska se připojí k počítači rozhraním, které přirozeně
	podporuje více připojených zařízení, například ethernet.
\end{compactenum}

Oba přístupy se v komerčních systémech pro digitální řízení modelové železnice
používají. Ať bude podpora více řídicích systému implementována kdekoliv, oproti
jednomu řídicímu systému vyžaduje tato podpora netriviální programovou podporu
navíc. Autor práce se rozhodl přesunout co nejvíce složitější logiky do počítačových
aplikací, protože se ty se mnohem snáze vyvíjejí, ladí a aktualizují než firmware
v embedded procesorech. V počítači můžeme navíc využívat vysokoúrovňovější
nástroje. Vydáme se tedy cestou, kdy se deska \textit{MTB-USB} bude v k počítači
připojovat již pomocí zmíněného virtuálního sériového portu. V počítači
naprogramujeme novou aplikaci \textit{MTB Daemon}, která se na jedné straně
připojí k \textit{MTB-USB} modulu a na straně druhé vystaví JSON TCP server
s jednoduchým API, které umožní povelovat \gls{mtb} moduly z více počítačových
programů. Získáme tím mj. velice hezké programové API, ke kterému se bude dát
snadno připojit z knihoven nejrůznějších programovacích jazyků, a tím
zpřístupníme systém \gls{mtb} širšímu spektru programátorů.

Protokol CDC mezi počítačem a \textit{MTB-USB} deskou zvolíme proto, že se
jedná de fakto o standard pro připojení specifických periferií k počítači,
například v oblasti robotiky. S výhodou využijeme toho, že protokol CDC má
nativní podporu ovladačů snad v majoritních operačních systémech a není tak
nutné instalovat speciální ovladače. Tento aspekt nám umožní budoucí snadné
nasazení u externích zákazníků.
